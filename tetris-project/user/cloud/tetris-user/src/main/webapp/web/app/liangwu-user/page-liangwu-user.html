<mi-frame id="page-liangwu-user-wrapper" :menus="menus" :user="user" :groups="groups" :active-id="activeId"
  v-loading="loading">

  <template slot="title">{{i18n.title}}</template>

  <template slot="links">
    <el-breadcrumb-item><a href="#/page-home">{{i18n.homePage}}</a></el-breadcrumb-item>
    <el-breadcrumb-item>{{i18n.currentPage}}</el-breadcrumb-item>
  </template>

  <template>
    <el-card class="box-card" shadow="hover" style="width:100%; height:100%;">

      <el-button type="primary" size="small" @click="handleCreate"><span
          class="icon-plus sp_title"></span>&nbsp;{{i18n.handleCreate}}</el-button>
      <!-- <el-button type="warning" size="small" @click="handelDelete"><span class="icon-trash sp_title"></span>&nbsp;删除用户</el-button> -->

      <el-button v-if="importInfo.status" size="small" disabled><span class="feather-icon-download-cloud"
          style="position:relative; right:1px;"></span>&nbsp;{{i18n.handleExportDisabled}}</el-button>
      <el-button v-else size="small" @click="handleExport"><span class="feather-icon-download-cloud"
          style="position:relative; right:1px;"></span>&nbsp;{{i18n.handleExport}}</el-button>

      <el-button v-if="importInfo.status" size="small" disabled><span class="feather-icon-upload-cloud"
          style="position:relative; right:1px;"></span>&nbsp;{{i18n.handleImportDisabled0}}{{importInfo.currentUser}}{{i18n.handleImportDisabled1}}{{importInfo.totalUsers}}
      </el-button>
      <el-button v-else size="small" @click="handleImport"><span class="feather-icon-upload-cloud"
          style="position:relative; right:1px;"></span>&nbsp;{{i18n.handleImport0}}{{importInfo.importTimes}}{{i18n.handleImport1}}
      </el-button>

      <div class="condition-item">
        <el-input v-model="table.condition.nickname" :placeholder="i18n.placeholderConditionNickname" clearable
          size="small"></el-input>
      </div>
      <div class="condition-item">
        <el-select v-model="table.condition.userType" size="small" @change="conditionUserTypeChange">
          <el-option label="个人用户" value="personal"></el-option>
          <el-option label="共享用户" value="share"></el-option>
        </el-select>
      </div>
      <el-button type="primary" size="small" style="margin-left:10px;" @click="load(1)">{{i18n.load}}</el-button>

      <div class="div_user_list">
        <el-scrollbar style="height:100%;">
          <el-table :data="tableData" :row-key="rowKey" style="width:100%" v-loading="loading">
            <!-- <el-table-column
                                type="selection"
                                width="55">
                        </el-table-column> -->
            <el-table-column :label="i18n.tableColumnNickname" prop="nickname">
            </el-table-column>
            <el-table-column :label="i18n.tableColumnUsername" prop="username">
            </el-table-column>
            <el-table-column :label="i18n.labelCreateUserRemark" prop="remark">
            </el-table-column>

            <el-table-column :label="i18n.labelCreateUserLastLoginTime" prop="lastLoginTime" width="250">
            </el-table-column>

            <el-table-column :label="i18n.labelCreateUserBindIp" prop="loginIp">
            </el-table-column>
            <el-table-column width="100" prop="status" label="登录状态" v-if="table.condition.userType == 'personal'">
              <template slot-scope="scope">
                <span v-if="scope.row.status === 'ONLINE'"
                  style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#67c23a; border-color:#67c23a; position:relative; top:2px;"></span>
                <span v-else
                  style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#f56c6c; border-color:#f56c6c; position:relative; top:2px;"></span>
              </template>
            </el-table-column>
            <el-table-column :label="i18n.tableColumnOperation" width="250">
              <template slot-scope="scope">
                <el-tooltip class="item" effect="dark" :content="i18n.tipHandleTokens" placement="bottom-end">
                  <el-button v-if="scope.row.id !== 2" type="text" icon="feather-icon-message-circle"
                    style="font-size:20px; padding:0;" @click="handleTokens(scope)"></el-button>
                </el-tooltip>
                <el-tooltip class="item" effect="dark" :content="i18n.tipHandleRowEdit" placement="bottom-end">
                  <el-button v-if="scope.row.classify==='LDAP'" type="text" icon="el-icon-edit" class="bt_list_handle"
                    disabled></el-button>
                  <el-button v-else type="text" icon="el-icon-edit" class="bt_list_handle"
                    @click="handleRowEdit(scope)"></el-button>
                </el-tooltip>
                <!-- <el-tooltip class="item" effect="dark" :content="i18n.tipGotoBindBusinessRole" placement="bottom-end">
                  <el-button type="text" icon="feather-icon-lock" class="bt_list_handle bt_list_center_handle"
                    @click="gotoBindBusinessRole(scope)"></el-button>
                </el-tooltip> -->
                <el-tooltip class="item" effect="dark" :content="i18n.tipHandleRowDelete" placement="bottom-end">
                  <el-button v-if="scope.row.classify==='LDAP'" type="text" icon="el-icon-delete"
                    class="bt_list_handle bt_list_center_handle" disabled></el-button>
                  <el-button v-else type="text" icon="el-icon-delete" class="bt_list_handle bt_list_center_handle"
                    @click="handleRowDelete(scope)"></el-button>
                </el-tooltip>
              </template>
            </el-table-column>
          </el-table>
        </el-scrollbar>
      </div>

      <div class="div_table_foot">
        <el-pagination style="float:right;" background @size-change="handleSizeChange"
          @current-change="handleCurrentChange" :current-page="table.currentPage" :page-sizes="table.pageSizes"
          :page-size="table.pageSize" layout="total, sizes, prev, pager, next, jumper" :total="table.total">
        </el-pagination>
      </div>

    </el-card>
    <!-- 新建用户 -->
    <el-dialog :title="i18n.dialogCreateUserTitle" :visible.sync="dialog.createUser.visible" width="700px"
      v-loading="createLoading" element-loading-text="新建用户中，请耐心等待。。。">
      <!-- :before-close="handleCreateUserClose"> -->

      <div class="div_create">
        <!-- <el-scrollbar style="height:100%;"> -->
        <el-form label-width="120px" size="mini">
          <el-form-item label="用户类型">
            <el-select v-model="dialog.createUser.userType" @change="userTypeChange">
              <el-option label="个人用户" value="personal"></el-option>
              <el-option label="共享用户" value="share"></el-option>
            </el-select>
          </el-form-item>
          <el-form-item :label="i18n.labelCreateUserNickname">
            <el-input v-model="dialog.createUser.nickname"></el-input>
          </el-form-item>
          <el-form-item :label="i18n.labelCreateUserUsername">
            <el-input v-model="dialog.createUser.username"></el-input>
          </el-form-item>
          <el-form-item v-show="false" :label="i18n.labelCreateUserUserno">
            <el-input v-model="dialog.createUser.userno"></el-input>
          </el-form-item>
          <el-form-item :label="i18n.labelCreateUserPassword">
            <el-input type="password" v-model="dialog.createUser.password"></el-input>
          </el-form-item>
          <el-form-item :label="i18n.labelCreateUserRepeat">
            <el-input type="password" v-model="dialog.createUser.repeat"
              :placeholder="i18n.placeholderCreateUserRepeat"></el-input>
          </el-form-item>
          <!-- 备注 -->
          <el-form-item :label="i18n.labelCreateUserRemark">
            <el-input v-model="dialog.createUser.remark"></el-input>
          </el-form-item>
          <!-- 绑定ip -->
          <el-form-item :label="i18n.labelCreateUserBindIp" v-if="dialog.createUser.userType=='personal'">
            <el-col :span="13">
              <el-input :disabled="isLoginIpDisabled" v-model="dialog.createUser.loginIp"></el-input>
            </el-col>
            <el-col :span="5" :offset="2">
              <el-checkbox v-model="dialog.createUser.isLoginIp" @change="isLoginIpChange">是否首次登录记录IP</el-checkbox>
            </el-col>
          </el-form-item>
          <!-- IP段 -->
          <el-form-item label="IP段" v-if="dialog.createUser.userType=='share'">
            <el-row>
              <el-col :span="7">
                <el-input v-model="dialog.createUser.loginIpBegin"></el-input>
              </el-col>
              <el-col :span="2" style="text-align: center;">至</el-col>
              <el-col :span="7">
                <el-input v-model="dialog.createUser.loginIpEnd"></el-input>
              </el-col>

              <el-col :span="7" :offset="1">
                <el-checkbox disabled v-model="dialog.createUser.isLoginIp" @change="isLoginIpChange">是否首次登录记录IP
                </el-checkbox>
              </el-col>
            </el-row>
          </el-form-item>

          <!-- 绑定角色 -->
          <el-form-item :label="i18n.labelCreateUserBindRole">
            <el-input v-model="dialog.createUser.bindrole" @click.native="handleChangeFolder"></el-input>
          </el-form-item>

          <!-- 绑定接入层 -->
          <el-form-item :label="i18n.labelCreateUserBindAccessNodeUid">
            <el-input v-model="bindAccessNodeUidName" @click.native="handleChangeNodeUid"></el-input>
          </el-form-item>


        </el-form>
        <!-- </el-scrollbar> -->
      </div>

      <span slot="footer" class="dialog-footer">
        <el-button size="medium" @click="dialog.createUser.visible = false">{{i18n.handleCreateUserCancel}}</el-button>
        <el-button size="medium" type="primary" @click="handleCreateUserSubmit" :loading="dialog.createUser.loading">
          {{i18n.handleCreateUserSubmit}}</el-button>
        <!-- <el-button @click="handleCreateShearUser">测试</el-button> -->
      </span>

    </el-dialog>


    <!-- 绑定角色对话框 -->
    <el-dialog title="绑定角色" :visible.sync="dialogBindRole.bindRoleDialogTableVisible">

      <el-table ref="roleTable" :data="roleOption" @selection-change="handleSelectionChange" :row-key="roleOption.id"
        width="100%">
        <el-table-column type="selection" width="55"></el-table-column>
        <el-table-column prop="name" label="名称" width="200"></el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="handleBindRoleSubmit"><span class="icon-plus"
          style="position:relative; right:1px;"></span>&nbsp;确定</el-button>

      <!-- <div>弹框</div> -->
    </el-dialog>

    <!-- 绑定接入层 -->
    <el-dialog title="绑定接入层" :visible.sync="bindAccessNodeUidVisable" width="500px">
      <el-table ref="accessNodeTable" :data="accessNodeTable" :row-key="roleOption.id" width="100%" height="400"
        @current-change="currentRowChange" highlight-current-row>
        <!-- <el-table-column type="selection" width="55"></el-table-column> -->
        <el-table-column prop="name" label="名称" width="200"></el-table-column>
        <el-table-column prop="ip" label="ip" width="200"></el-table-column>
      </el-table>
      <el-button type="primary" size="small" @click="handleBindAccessNodeUidSubmit" style="margin-top:15px"><span
          class="icon-plus" style="position:relative; right:1px;"></span>&nbsp;确定</el-button>

      <!-- <div>弹框</div> -->
    </el-dialog>
    <!-- 修改用户对话框 -->
    <el-dialog :title="i18n.dialogEditUserTitle" :visible.sync="dialog.editUser.visible" width="600px"
      :before-close="handleEditUserClose" v-loading="dialog.editUser.loading" element-loading-text="修改用户中，请耐心等待。。。">

      <div>
        <el-form label-width="110px" size="mini">
          <el-form-item :label="i18n.labelEditUserNickname">
            <el-input v-model="dialog.editUser.nickname"></el-input>
          </el-form-item>

          <!-- 备注 -->
          <el-form-item :label="i18n.labelCreateUserRemark">
            <el-input v-model="dialog.editUser.remark"></el-input>
          </el-form-item>
          <!-- 绑定ip -->
          <el-form-item :label="i18n.labelCreateUserBindIp" v-if="table.condition.userType=='personal'">
            <!-- <el-col :span="13"> -->
            <el-input v-model="dialog.editUser.loginIp"></el-input>
            <!-- </el-col> -->
            <!-- <el-col :span="5" :offset="2">
              <el-checkbox v-model="dialog.editUser.isLoginIp" @change="isLoginIpChange">是否首次登录记录IP</el-checkbox>
            </el-col> -->
          </el-form-item>
          <!-- 绑定角色 -->

          <el-form-item :label="i18n.labelCreateUserBindRole">
            <el-input v-model="dialog.editUser.bindrole" @click.native="handleChangeFolder"></el-input>
          </el-form-item>
          <!-- 绑定接入层 -->
          <!-- <el-form-item :label="i18n.labelCreateUserBindAccessNodeUid">
            <el-input v-model="dialog.editUser.bindAccessNodeUidName" @click.native="handleChangeNodeUid"></el-input>
          </el-form-item> -->
          <div class="div_change_pw">
            <el-button class="bt_change_pw" type="text"
              @click="dialog.editUser.editPassword=!dialog.editUser.editPassword">
              {{i18n.labelEditUserEditPassword}}
              <span v-if="dialog.editUser.editPassword" class="el-icon-arrow-up"></span>
              <span v-else class="el-icon-arrow-down"></span>
            </el-button>
          </div>
          <el-form-item v-if="dialog.editUser.editPassword" :label="i18n.labelEditUserOldPassword">
            <el-input type="password" v-model="dialog.editUser.oldPassword"></el-input>
          </el-form-item>
          <el-form-item v-if="dialog.editUser.editPassword" :label="i18n.labelEditUserNewPassword">
            <el-input type="password" v-model="dialog.editUser.newPassword"></el-input>
          </el-form-item>
          <el-form-item v-if="dialog.editUser.editPassword" :label="i18n.labelEditUserRepeat">
            <el-input type="password" v-model="dialog.editUser.repeat" :placeholder="i18n.placeholderEditUserRepeat">
            </el-input>
          </el-form-item>
        </el-form>
      </div>

      <span slot="footer" class="dialog-footer">
        <el-button size="medium" @click="dialog.editUser.visible = false">{{i18n.handleEditUserCancel}}</el-button>
        <el-button size="medium" type="primary" @click="handleEditUserSubmit" :loading="dialog.editUser.loading">
          {{i18n.handleEditUserSubmit}}</el-button>
      </span>

    </el-dialog>




    <!-- token展示 -->
    <el-dialog :title="dialog.tokens.currentUser.nickname" :visible.sync="dialog.tokens.visible" width="600px"
      :before-close="handleTokensClose">

      <el-table :data="dialog.tokens.rows" style="width:100%">
        <el-table-column width="50" prop="status">
          <template slot-scope="scope">
            <span v-if="scope.row.status === 'ONLINE'"
              style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#67c23a; border-color:#67c23a; position:relative; top:2px;"></span>
            <span v-if="scope.row.status === 'OFFLINE'"
              style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#f56c6c; border-color:#f56c6c; position:relative; top:2px;"></span>
          </template>
        </el-table-column>
        <el-table-column :label="i18n.tableTokensColumnType">
          <template slot-scope="scope">
            <span v-if="scope.row.type == 'qt指控软件'">客户端软件</span>
            <span v-if="scope.row.type == 'pc平台'">服务器平台</span>
            <span v-if="scope.row.type != 'qt指控软件'&&scope.row.type != 'pc平台'">{{scope.row.type}}</span>
          </template>
        </el-table-column>
        <el-table-column :label="i18n.tableTokensColumnIp" prop="ip">
        </el-table-column>
        <el-table-column :label="i18n.tableTokensColumnOperation" width="80">
          <template slot-scope="scope">
            <el-tooltip class="item" effect="dark" :content="i18n.tipHandleInvalidToken" placement="bottom-end">
              <el-button type="text" class="danger" icon="feather-icon-x-circle" style="font-size:20px; padding:0;"
                @click="handleInvalidToken(scope)"></el-button>
            </el-tooltip>
          </template>
        </el-table-column>
      </el-table>

    </el-dialog>

  </template>
  <!-- 共享用户登录状态 -->
  <el-dialog title="共享用户列表" :visible.sync="dialog.shareUser.visible" width="600px">
    <el-table :data="shareUserData" style="width:100%">
      <el-table-column label="用户名" prop="username">
      </el-table-column>
      <!-- <el-table-column width="100" prop="status" label="登录状态">
        <template slot-scope="scope">
          <span v-if="scope.row.status === 'ONLINE'"
            style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#67c23a; border-color:#67c23a; position:relative; top:2px;"></span>
          <span v-else
            style="display:inline-block; width:20px; height:20px; border-radius:100%; background-color:#f56c6c; border-color:#f56c6c; position:relative; top:2px;"></span>
        </template>
      </el-table-column> -->
      <el-table-column :label="i18n.tableTokensColumnOperation" width="80">
        <template slot-scope="scope">
          <el-tooltip class="item" effect="dark" :content="i18n.tipHandleTokens" placement="bottom-end">
            <el-button v-if="scope.row.id !== 2" type="text" icon="feather-icon-message-circle"
              style="font-size:20px; padding:0;" @click="handleShareTokens(scope)"></el-button>
          </el-tooltip>
        </template>
      </el-table-column>
    </el-table>

  </el-dialog>
  <template>
    <a id="page-business-user-export"></a>
    <mi-upload-dialog ref="miUploadDialog" :require-type="dialog.import.requireType" :multiple="dialog.import.multiple"
      @file-selected="fileSelected"></mi-upload-dialog>
  </template>

</mi-frame>