<mi-frame id="page-layout-forward-wrapper" :menus="menus" :user="user" :groups="groups">

    <template slot="title">虚拟源显示配置</template>

    <template slot="links">
        <el-breadcrumb-item><a href="#/page-home">首页</a></el-breadcrumb-item>
        <el-breadcrumb-item><a href="#/page-layout">{{layoutName}}</a></el-breadcrumb-item>
        <el-breadcrumb-item>虚拟源显示配置</el-breadcrumb-item>
    </template>

    <template>

        <el-card class="box-card" shadow="hover" style="width:100%; height:100%;">
            <div style="position:absolute; left:0; top:0; width:300px; bottom:0; box-sizing:border-box; border-right:1px solid #ebebeb;">
                <div style="width:100%; height:100%; position:relative;">
                    <div style="width:280px; height:280px; margin:auto; box-sizing:border-box; background-color:#000; position:relative; top:10px;">
                        <div :draggable="position.disabled?false:true"
                             v-for="position in positions.rows"
                             :style="positionStyle(position, 280, 280)"
                             :class="'position-preview' + (position.disabled?' disabled':(position.selected?' selected':''))"
                             @click.stop="handleSelectPosition(position)">
                            <div>布局{{position.serialNum}}（{{position.typeName}}）</div>
                        </div>
                    </div>
                    <div style="position:absolute; top:300px; left:0; right:0; bottom:0; box-sizing:border-box; border-top:1px solid #ebebeb;">
                        <el-scrollbar style="height:100%;">
                            <div :draggable="position.disabled?false:true"
                                 v-for="position in positions.rows"
                                 :class="'layout-position' + (position.disabled?' disabled':(position.selected?' selected':''))"
                                 @click.stop="handleSelectPosition(position)">布局{{position.serialNum}}（{{position.typeName}}）</div>
                        </el-scrollbar>
                    </div>
                </div>
            </div>
            <div style="position:absolute; left:300px; top:0; right:300px; bottom:0;">
                <div style="width:100%; height:100%; position:relative;">
                    <div class="terminal-selection" style="padding:10px; border-bottom:1px solid #ededed;">
                        <el-select v-model="terminal.current" size="small" placeholder="请选择终端">
                            <el-option v-for="terminal in terminal.rows" :key="terminal.id" :label="terminal.name" :value="terminal.id"></el-option>
                        </el-select>
                        <el-select v-model="physicalScreen.current" size="small" placeholder="请选择屏幕" style="margin-left:10px;">
                            <el-option v-for="screen in physicalScreen.rows" :key="screen.id" :label="screen.name" :value="screen.id"></el-option>
                        </el-select>
                        <el-button size="small" type="primary" style="margin-left:10px; border-radius:0; position:relative; bottom:1px;" @click="handleAddDecodes">添加解码</el-button>
                        <el-button size="small" style="float:right; border-radius:0; padding:2px 1px 1px 1px;"><span class="el-icon-menu" style="font-size:28px;"></span></el-button>
                    </div>
                        <div style="position:absolute; left:0; top:54px; right:0; bottom:0;">
                            <div style="width:100%; height:100%; position:relative; padding:10px; box-sizing:border-box;" class="physical-screen-scope">
                                <div v-if="physicalScreen.current" style="width:100%; height:100%; position:relative; box-sizing:border-box; background-color:#000;">
                                    <div v-for="decodeSetting, i in decodeSettings.data" :key="i" :style="decodePositionStyle(decodeSetting)" :class="'decode-position-preview'+(decodeSetting.current?' current':'')" @click.stop="handleDecodeSelect(decodeSetting)">
                                        <div style="width:100%; height:100%; display:table; text-align:center;">
                                            <div style="width:100%; height:100%; display:table-cell; vertical-align:middle; color:#fff;">{{decodeSetting.name}}</div>
                                        </div>
                                        <div v-for="sourcePositionSetting, i in decodeSetting.children[0].children" :key="i" :style="sourcePositionStyle(sourcePositionSetting, decodeSetting._width, decodeSetting._height)" :class="'source-position-preview'+(sourcePositionSetting.current?' current':'')">
                                            <div style="width:100%; height:100%; display:table; text-align:center;">
                                                <div style="width:100%; height:100%; display:table-cell; vertical-align:middle; color:#606266;">{{sourcePositionSetting.name}}</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                    </div>
                </div>
            </div>
            <div style="width:300px; position:absolute; top:0; right:0; bottom:0; box-sizing:border-box; border-left:1px solid #ebebeb;">
                <div style="width:100%; height:40%; box-sizing:border-box; border-bottom:1px solid #ededed; padding:10px; box-sizing:border-box;">
                    <el-scrollbar style="height:100%;">
                        <el-tree
                            ref="decodeSettingTree"
                            @current-change="handleCurrentNodeChange"
                            :expand-on-click-node="false"
                            default-expand-all
                            :data="decodeSettings.data"
                            :props="decodeSettings.props"
                            highlight-current	>
                            <span slot-scope="scope" style="flex:1; display:flex; align-items:center; justify-content:space-between; font-size:14px; padding-right:8px;">
                                <span>{{scope.node.label}}</span>
                                <span>
                                    <el-button v-if="scope.data.type==='DECODE_CHANNEL' || scope.data.type==='FORWARD' || scope.data.type==='COMBINE_TEMPLATE'" icon="el-icon-plus" type="text" style="padding:0; margin:0;" @click.stop="handleAddPosition(scope)"></el-button>
                                    <el-button v-else icon="el-icon-delete" type="text" style="padding:0; margin:0;" @click.stop="handleRemovePosition(scope)"></el-button>
                                    <el-button v-if="scope.data.type==='DECODE_CHANNEL'" icon="el-icon-delete" type="text" style="padding:0; margin:0;" @click="handleRemoveLayoutForward(scope)"></el-button>
                                    <el-button v-if="scope.data.type==='FORWARD' || scope.data.type==='COMBINE_TEMPLATE'" icon="el-icon-delete" type="text" style="padding:0; margin:0;" disabled></el-button>
                                </span>
                            </span>
                        </el-tree>
                    </el-scrollbar>
                </div>
                <div class="form-scope" style="width:100%; height:60%; box-sizing:border-box; padding:10px;">
                    <el-scrollbar style="height:100%;">
                        <div v-if="decodeSettings.current.type === 'DECODE_CHANNEL'">
                            <div style="margin-bottom:5px;">
                                <el-radio-group v-model="decodeSettings.current.children[0].type" @change="handleDecodeForwardSourceTypeChange">
                                    <el-radio label="FORWARD">转发</el-radio>
                                    <el-radio label="COMBINE_TEMPLATE">合屏</el-radio>
                                </el-radio-group>
                                <el-checkbox v-model="decodeSettings.current.enablePosition" style="float:right;" @change="handleDecodeEnablePositionChange">启用布局</el-checkbox>
                            </div>
                            <el-form v-if="decodeSettings.current.enablePosition" label-position="top" label-width="80px">
                                <el-form-item label="左偏移">
                                    <el-input-number size="small" v-model="decodeSettings.current.x" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="上偏移">
                                    <el-input-number size="small" v-model="decodeSettings.current.y" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="宽度">
                                    <el-input-number size="small" v-model="decodeSettings.current.width" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="高度">
                                    <el-input-number size="small" v-model="decodeSettings.current.height" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="涂层">
                                    <el-input-number size="small" v-model="decodeSettings.current.zIndex" :min="0" :step="1" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="">
                                    <div style="width:100%;">
                                        <div style="width:50%; float:left; padding-right:5px; box-sizing:border-box;">
                                            <el-button style="width:100%; border-radius:0;" size="small" @click.stop="handleCancelDecodeEdit">取消</el-button>
                                        </div>
                                        <div style="width:50%; float:left; padding-left:5px; box-sizing:border-box;">
                                            <el-button style="width:100%; border-radius:0;" type="primary" size="small" @click.stop="handleSaveDecodeEdit">保存</el-button>
                                        </div>
                                        <div style="clear:both;"></div>
                                    </div>
                                </el-form-item>
                            </el-form>

                        </div>
                        <div v-if="decodeSettings.current.type === 'LAYOUT_POSITION'">

                        </div>
                        <div v-if="decodeSettings.current.type === 'COMBINE_TEMPLATE_POSITION'">
                            <el-form label-position="top" label-width="80px">
                                <el-form-item label="左偏移">
                                    <el-input-number size="small" v-model="decodeSettings.current.x" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="上偏移">
                                    <el-input-number size="small" v-model="decodeSettings.current.y" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="宽度">
                                    <el-input-number size="small" v-model="decodeSettings.current.width" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="高度">
                                    <el-input-number size="small" v-model="decodeSettings.current.height" :min="0" :max="10000" :step="100" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="涂层">
                                    <el-input-number size="small" v-model="decodeSettings.current.zIndex" :min="0" :step="1" style="width:100%;"></el-input-number>
                                </el-form-item>
                                <el-form-item label="">
                                    <div style="width:100%;">
                                        <div style="width:50%; float:left; padding-right:5px; box-sizing:border-box;">
                                            <el-button style="width:100%; border-radius:0;" size="small" @click.stop="handleCancelCombineTemplatePositionEdit">取消</el-button>
                                        </div>
                                        <div style="width:50%; float:left; padding-left:5px; box-sizing:border-box;">
                                            <el-button style="width:100%; border-radius:0;" type="primary" size="small" @click.stop="handleSaveCombineTemplatePositionEdit">保存</el-button>
                                        </div>
                                        <div style="clear:both;"></div>
                                    </div>
                                </el-form-item>
                            </el-form>
                        </div>
                    </el-scrollbar>
                </div>
            </div>
        </el-card>

        <el-dialog
                :visible.sync="dialog.addDecode.visible"
                width="300px"
                :before-close="handleAddDecodeClose"
                :close-on-click-modal="false">
            <span slot="title">
                <el-popover
                    ref="decodeSelectorHelper"
                    placement="right"
                    title="说明"
                    width="200"
                    trigger="click"
                    content="自选解码是以固定解码解源，随机解码则由程序自动选择，二者互斥">
                    <el-button slot="reference" style="margin:0; padding:0; border:0; position:relative; bottom:2px;" icon="el-icon-question"></el-button>
                </el-popover>
                <span>{{dialog.addDecode.mode==='NONE'?'':dialog.addDecode.mode==='CONFIRM'?'自选解码':'随机解码'}}</span>
            </span>
            <div>
                <div style="border-bottom:1px solid #ededed; padding-bottom:10px; margin-bottom:10px;">
                    <div v-for="channel in dialog.addDecode.confirm">
                        <el-checkbox v-model="channel.checked" style="margin-bottom:5px;" @change="decodeCheckedChange(channel, $event)">{{channel.name}}</el-checkbox>
                    </div>
                </div>
                <div>
                    <div v-for="channel in dialog.addDecode.adaptable">
                        <el-checkbox v-model="channel.checked" style="margin-bottom:5px;" @change="decodeCheckedChange(channel, $event)">{{channel.name}}</el-checkbox>
                    </div>
                </div>
            </div>

            <span slot="footer" class="dialog-footer">
                <el-button size="medium" @click="handleAddDecodeClose">取消</el-button>
                <el-button size="medium" type="primary" @click="handleAddDecodeSubmit" :loading="dialog.addDecode.loading">确定</el-button>
            </span>
        </el-dialog>

        <el-dialog
                title="选择虚拟源布局"
                :visible.sync="dialog.addCombinePosition.visible"
                width="300px"
                :before-close="handleAddCombinePositionClose"
                :close-on-click-modal="false">

            <div v-for="(position,i) in dialog.addCombinePosition.data" :key="i" style="margin-bottom:5px;">
                <el-checkbox v-model="position.checked">布局{{position.serialNum}}（{{position.typeName}}）</el-checkbox>
            </div>

            <span slot="footer" class="dialog-footer">
                <el-button size="medium" @click="handleAddCombinePositionClose">取消</el-button>
                <el-button size="medium" type="primary" @click="handleAddCombinePositionSubmit" :loading="dialog.addCombinePosition.loading">确定</el-button>
            </span>
        </el-dialog>

        <el-dialog
                title="选择虚拟源布局"
                :visible.sync="dialog.addForwardPosition.visible"
                width="300px"
                :before-close="handleAddForwardPositionClose"
                :close-on-click-modal="false">

            <div v-for="(position,i) in dialog.addForwardPosition.data" :key="i" style="margin-bottom:5px;">
                <el-radio v-model="dialog.addForwardPosition.selectedPosition" :label="position.id">布局{{position.serialNum}}（{{position.typeName}}）</el-radio>
            </div>

            <span slot="footer" class="dialog-footer">
                <el-button size="medium" @click="handleAddForwardPositionClose">取消</el-button>
                <el-button size="medium" type="primary" @click="handleAddForwardPositionSubmit" :loading="dialog.addForwardPosition.loading">确定</el-button>
            </span>
        </el-dialog>

    </template>

</mi-frame>